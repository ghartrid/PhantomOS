/*
 * ==============================================================================
 *                       PHANTOM ANTI-MALWARE SCANNER
 *                      "To Create, Not To Destroy"
 * ==============================================================================
 *
 * File-based malware scanner for PhantomOS.
 * Provides real-time protection and on-demand scanning.
 *
 * Features:
 * - Signature-based detection (MD5/SHA256 hash matching)
 * - Heuristic analysis (suspicious patterns, entropy, imports)
 * - File type detection by magic bytes
 * - Real-time monitoring via inotify
 * - Quarantine system for safe isolation
 * - All local - no data sent externally
 */

#ifndef PHANTOM_ANTIMALWARE_H
#define PHANTOM_ANTIMALWARE_H

#include <stdint.h>
#include <stddef.h>
#include <time.h>
#include <pthread.h>

/* ─────────────────────────────────────────────────────────────────────────────
 * Constants
 * ───────────────────────────────────────────────────────────────────────────── */

#define ANTIMALWARE_MAX_PATH         4096
#define ANTIMALWARE_MAX_FILENAME     256
#define ANTIMALWARE_MAX_REASON       512
#define ANTIMALWARE_HASH_SIZE        32      /* SHA-256 = 32 bytes */
#define ANTIMALWARE_HASH_HEX_SIZE    65      /* 64 hex chars + null */
#define ANTIMALWARE_MAGIC_SIZE       16      /* Magic bytes to read */
#define ANTIMALWARE_MAX_SIGNATURES   500000  /* Max signatures in DB */
#define ANTIMALWARE_HASH_BUCKETS     65536   /* Hash table buckets */
#define ANTIMALWARE_MAX_SCAN_SIZE    (100 * 1024 * 1024)  /* 100MB max file */
#define ANTIMALWARE_QUARANTINE_EXT   ".quarantine"

/* ─────────────────────────────────────────────────────────────────────────────
 * Threat Classification
 * ───────────────────────────────────────────────────────────────────────────── */

typedef enum {
    THREAT_CLEAN = 0,           /* No threats detected */
    THREAT_SUSPICIOUS = 1,      /* Heuristic match, possible threat */
    THREAT_MALWARE = 2,         /* Confirmed malware signature */
    THREAT_RANSOMWARE = 3,      /* Ransomware behavior detected */
    THREAT_TROJAN = 4,          /* Trojan signature */
    THREAT_VIRUS = 5,           /* File infector */
    THREAT_WORM = 6,            /* Self-replicating */
    THREAT_ROOTKIT = 7,         /* Rootkit behavior */
    THREAT_ADWARE = 8,          /* Adware/PUP */
    THREAT_SPYWARE = 9,         /* Spyware/keylogger */
    THREAT_CRYPTOMINER = 10,    /* Unauthorized cryptominer */
    THREAT_BACKDOOR = 11        /* Backdoor/RAT */
} antimalware_threat_t;

/* ─────────────────────────────────────────────────────────────────────────────
 * Heuristic Flags (bitfield)
 * ───────────────────────────────────────────────────────────────────────────── */

#define HEURISTIC_NONE              0x00000000
#define HEURISTIC_PACKED            0x00000001  /* UPX/packed executable */
#define HEURISTIC_HIGH_ENTROPY      0x00000002  /* Encrypted/compressed data */
#define HEURISTIC_SUSPICIOUS_IMPORT 0x00000004  /* Dangerous API imports */
#define HEURISTIC_HIDDEN_EXTENSION  0x00000008  /* Double extension trick */
#define HEURISTIC_OBFUSCATED        0x00000010  /* Obfuscated strings/code */
#define HEURISTIC_SHELL_SPAWN       0x00000020  /* Spawns shell commands */
#define HEURISTIC_NETWORK_ACCESS    0x00000040  /* Suspicious network code */
#define HEURISTIC_FILE_DROPPER      0x00000080  /* Drops files to system */
#define HEURISTIC_PERSISTENCE       0x00000100  /* Autostart mechanisms */
#define HEURISTIC_PRIVILEGE_ESCALATION 0x00000200 /* Privilege escalation */
#define HEURISTIC_ANTI_DEBUG        0x00000400  /* Anti-debugging tricks */
#define HEURISTIC_ANTI_VM           0x00000800  /* VM detection code */
#define HEURISTIC_CRYPTO_STRINGS    0x00001000  /* Ransomware indicators */
#define HEURISTIC_KEYLOGGER         0x00002000  /* Keyboard hooking */
#define HEURISTIC_SCREEN_CAPTURE    0x00004000  /* Screenshot capability */
#define HEURISTIC_WEBCAM_ACCESS     0x00008000  /* Camera access */
#define HEURISTIC_PASSWORD_THEFT    0x00010000  /* Credential harvesting */
#define HEURISTIC_SUSPICIOUS_PERMS  0x00020000  /* Suspicious file permissions */
#define HEURISTIC_SCRIPT_IN_BINARY  0x00040000  /* Script embedded in binary */

/* ─────────────────────────────────────────────────────────────────────────────
 * File Types (detected by magic bytes)
 * ───────────────────────────────────────────────────────────────────────────── */

typedef enum {
    FILETYPE_UNKNOWN = 0,
    FILETYPE_ELF,               /* Linux executable */
    FILETYPE_PE,                /* Windows executable */
    FILETYPE_MACHO,             /* macOS executable */
    FILETYPE_SCRIPT_SHELL,      /* Shell script */
    FILETYPE_SCRIPT_PYTHON,     /* Python script */
    FILETYPE_SCRIPT_PERL,       /* Perl script */
    FILETYPE_SCRIPT_PHP,        /* PHP script */
    FILETYPE_SCRIPT_JS,         /* JavaScript */
    FILETYPE_PDF,               /* PDF document */
    FILETYPE_OFFICE_DOC,        /* MS Office document */
    FILETYPE_OFFICE_DOCX,       /* Office Open XML */
    FILETYPE_ZIP,               /* ZIP archive */
    FILETYPE_GZIP,              /* Gzip compressed */
    FILETYPE_TAR,               /* Tar archive */
    FILETYPE_RAR,               /* RAR archive */
    FILETYPE_7ZIP,              /* 7-Zip archive */
    FILETYPE_ISO,               /* ISO image */
    FILETYPE_JAR,               /* Java archive */
    FILETYPE_APK,               /* Android package */
    FILETYPE_DEB,               /* Debian package */
    FILETYPE_RPM,               /* RPM package */
    FILETYPE_IMAGE,             /* Image file */
    FILETYPE_AUDIO,             /* Audio file */
    FILETYPE_VIDEO,             /* Video file */
    FILETYPE_TEXT,              /* Plain text */
    FILETYPE_HTML,              /* HTML document */
    FILETYPE_XML,               /* XML document */
    FILETYPE_JSON               /* JSON data */
} antimalware_filetype_t;

/* ─────────────────────────────────────────────────────────────────────────────
 * Scan Result
 * ───────────────────────────────────────────────────────────────────────────── */

typedef struct antimalware_scan_result {
    /* File information */
    char filepath[ANTIMALWARE_MAX_PATH];
    char filename[ANTIMALWARE_MAX_FILENAME];
    uint64_t file_size;
    time_t file_mtime;
    antimalware_filetype_t file_type;

    /* Threat information */
    antimalware_threat_t threat_level;
    uint32_t heuristic_flags;
    int threat_score;                        /* 0-100, higher = worse */
    char threat_name[128];                   /* Signature name if matched */
    char threat_description[ANTIMALWARE_MAX_REASON];

    /* Hash information */
    char hash_md5[33];                       /* MD5 hex string */
    char hash_sha256[ANTIMALWARE_HASH_HEX_SIZE];

    /* Heuristic details */
    double entropy;                          /* File entropy (0-8) */
    int suspicious_strings_count;
    int suspicious_imports_count;

    /* Timing */
    double scan_time_ms;
    int scan_complete;
} antimalware_scan_result_t;

/* ─────────────────────────────────────────────────────────────────────────────
 * Signature Database Entry
 * ───────────────────────────────────────────────────────────────────────────── */

typedef struct antimalware_signature {
    uint32_t hash_prefix;                    /* First 4 bytes of hash */
    char hash_sha256[ANTIMALWARE_HASH_HEX_SIZE];
    char threat_name[64];
    antimalware_threat_t threat_type;
    struct antimalware_signature *next;
} antimalware_signature_t;

/* ─────────────────────────────────────────────────────────────────────────────
 * Quarantine Entry
 * ───────────────────────────────────────────────────────────────────────────── */

typedef struct antimalware_quarantine_entry {
    char original_path[ANTIMALWARE_MAX_PATH];
    char quarantine_path[ANTIMALWARE_MAX_PATH];
    char threat_name[128];
    antimalware_threat_t threat_type;
    time_t quarantine_time;
    uint64_t file_size;
    char hash_sha256[ANTIMALWARE_HASH_HEX_SIZE];
    struct antimalware_quarantine_entry *next;
} antimalware_quarantine_entry_t;

/* ─────────────────────────────────────────────────────────────────────────────
 * Real-Time Monitor Entry
 * ───────────────────────────────────────────────────────────────────────────── */

typedef struct antimalware_watch {
    int watch_descriptor;
    char path[ANTIMALWARE_MAX_PATH];
    int recursive;
    struct antimalware_watch *next;
} antimalware_watch_t;

/* ─────────────────────────────────────────────────────────────────────────────
 * Scan Options
 * ───────────────────────────────────────────────────────────────────────────── */

typedef struct antimalware_scan_options {
    int scan_archives;           /* Scan inside archives */
    int scan_hidden;             /* Scan hidden files/dirs */
    int recursive;               /* Recursive directory scan */
    int heuristics_enabled;      /* Enable heuristic analysis */
    int max_depth;               /* Max recursion depth (0 = unlimited) */
    uint64_t max_file_size;      /* Skip files larger than this */
    int quick_scan;              /* Quick scan (signatures only) */
    int follow_symlinks;         /* Follow symbolic links */

    /* Callback for progress reporting */
    void (*progress_callback)(const char *filepath, int percent, void *userdata);
    void (*threat_callback)(const antimalware_scan_result_t *result, void *userdata);
    void *callback_userdata;
} antimalware_scan_options_t;

/* ─────────────────────────────────────────────────────────────────────────────
 * Scanner Context
 * ───────────────────────────────────────────────────────────────────────────── */

typedef struct phantom_antimalware {
    int initialized;

    /* Signature database */
    antimalware_signature_t *signature_table[ANTIMALWARE_HASH_BUCKETS];
    uint32_t signature_count;
    char signature_db_path[ANTIMALWARE_MAX_PATH];
    time_t signature_db_date;

    /* Quarantine */
    char quarantine_path[ANTIMALWARE_MAX_PATH];
    antimalware_quarantine_entry_t *quarantine_list;
    uint32_t quarantine_count;
    pthread_mutex_t quarantine_lock;

    /* Real-time monitoring */
    int realtime_enabled;
    int inotify_fd;
    antimalware_watch_t *watches;
    pthread_t monitor_thread;
    volatile int monitor_running;
    pthread_mutex_t monitor_lock;

    /* Exclusions */
    char **exclusion_paths;
    uint32_t exclusion_count;
    uint32_t exclusion_capacity;

    /* Statistics */
    uint64_t total_scans;
    uint64_t files_scanned;
    uint64_t threats_found;
    uint64_t files_quarantined;
    uint64_t scan_errors;
    double total_scan_time_ms;

    /* Scan state (for current scan) */
    volatile int scan_in_progress;
    volatile int scan_cancelled;
    uint64_t current_scan_files;
    uint64_t current_scan_threats;

    /* Default scan options */
    antimalware_scan_options_t default_options;
} phantom_antimalware_t;

/* ─────────────────────────────────────────────────────────────────────────────
 * Core API Functions
 * ───────────────────────────────────────────────────────────────────────────── */

/* Initialize the anti-malware scanner */
int phantom_antimalware_init(phantom_antimalware_t *scanner);

/* Shutdown and cleanup */
void phantom_antimalware_shutdown(phantom_antimalware_t *scanner);

/* ─────────────────────────────────────────────────────────────────────────────
 * Signature Database Functions
 * ───────────────────────────────────────────────────────────────────────────── */

/* Load signature database from file
 * Format: SHA256_HASH:THREAT_TYPE:THREAT_NAME (one per line)
 * Returns number of signatures loaded, or -1 on error */
int phantom_antimalware_load_signatures(phantom_antimalware_t *scanner,
                                         const char *filepath);

/* Load all signature files from a directory */
int phantom_antimalware_load_signature_dir(phantom_antimalware_t *scanner,
                                            const char *dirpath);

/* Add single signature manually */
int phantom_antimalware_add_signature(phantom_antimalware_t *scanner,
                                       const char *hash_sha256,
                                       const char *threat_name,
                                       antimalware_threat_t threat_type);

/* Check if hash exists in signature database */
antimalware_signature_t *phantom_antimalware_lookup_hash(
    phantom_antimalware_t *scanner, const char *hash_sha256);

/* Get signature count */
uint32_t phantom_antimalware_get_signature_count(phantom_antimalware_t *scanner);

/* Clear all signatures */
void phantom_antimalware_clear_signatures(phantom_antimalware_t *scanner);

/* ─────────────────────────────────────────────────────────────────────────────
 * Scanning Functions
 * ───────────────────────────────────────────────────────────────────────────── */

/* Scan a single file */
int phantom_antimalware_scan_file(phantom_antimalware_t *scanner,
                                   const char *filepath,
                                   antimalware_scan_result_t *result,
                                   const antimalware_scan_options_t *options);

/* Scan a directory (optionally recursive) */
int phantom_antimalware_scan_directory(phantom_antimalware_t *scanner,
                                        const char *dirpath,
                                        const antimalware_scan_options_t *options);

/* Quick scan of common malware locations */
int phantom_antimalware_quick_scan(phantom_antimalware_t *scanner,
                                    const antimalware_scan_options_t *options);

/* Full system scan */
int phantom_antimalware_full_scan(phantom_antimalware_t *scanner,
                                   const antimalware_scan_options_t *options);

/* Cancel ongoing scan */
void phantom_antimalware_cancel_scan(phantom_antimalware_t *scanner);

/* Check if scan is in progress */
int phantom_antimalware_scan_active(phantom_antimalware_t *scanner);

/* ─────────────────────────────────────────────────────────────────────────────
 * Heuristic Analysis Functions
 * ───────────────────────────────────────────────────────────────────────────── */

/* Perform heuristic analysis on a file */
int phantom_antimalware_analyze_heuristics(phantom_antimalware_t *scanner,
                                            const char *filepath,
                                            uint8_t *file_data,
                                            size_t file_size,
                                            antimalware_scan_result_t *result);

/* Calculate file entropy */
double phantom_antimalware_calculate_entropy(const uint8_t *data, size_t size);

/* Detect file type by magic bytes */
antimalware_filetype_t phantom_antimalware_detect_filetype(
    const uint8_t *data, size_t size, const char *filename);

/* Check for suspicious strings */
int phantom_antimalware_check_strings(const uint8_t *data, size_t size,
                                       antimalware_scan_result_t *result);

/* Check ELF imports for suspicious functions */
int phantom_antimalware_check_elf_imports(const uint8_t *data, size_t size,
                                           antimalware_scan_result_t *result);

/* ─────────────────────────────────────────────────────────────────────────────
 * Real-Time Monitoring Functions
 * ───────────────────────────────────────────────────────────────────────────── */

/* Start real-time protection */
int phantom_antimalware_start_realtime(phantom_antimalware_t *scanner);

/* Stop real-time protection */
void phantom_antimalware_stop_realtime(phantom_antimalware_t *scanner);

/* Add directory to real-time monitoring */
int phantom_antimalware_watch_directory(phantom_antimalware_t *scanner,
                                         const char *dirpath, int recursive);

/* Remove directory from monitoring */
int phantom_antimalware_unwatch_directory(phantom_antimalware_t *scanner,
                                           const char *dirpath);

/* Check if real-time protection is active */
int phantom_antimalware_realtime_active(phantom_antimalware_t *scanner);

/* ─────────────────────────────────────────────────────────────────────────────
 * Quarantine Functions
 * ───────────────────────────────────────────────────────────────────────────── */

/* Set quarantine directory */
int phantom_antimalware_set_quarantine_path(phantom_antimalware_t *scanner,
                                             const char *path);

/* Move file to quarantine */
int phantom_antimalware_quarantine_file(phantom_antimalware_t *scanner,
                                         const char *filepath,
                                         const antimalware_scan_result_t *result);

/* Restore file from quarantine */
int phantom_antimalware_restore_file(phantom_antimalware_t *scanner,
                                      const char *quarantine_path);

/* Delete file from quarantine */
int phantom_antimalware_delete_quarantined(phantom_antimalware_t *scanner,
                                            const char *quarantine_path);

/* List quarantined files */
antimalware_quarantine_entry_t *phantom_antimalware_list_quarantine(
    phantom_antimalware_t *scanner);

/* Get quarantine count */
uint32_t phantom_antimalware_get_quarantine_count(phantom_antimalware_t *scanner);

/* Empty quarantine (delete all) */
int phantom_antimalware_empty_quarantine(phantom_antimalware_t *scanner);

/* ─────────────────────────────────────────────────────────────────────────────
 * Exclusion Functions
 * ───────────────────────────────────────────────────────────────────────────── */

/* Add path to exclusion list */
int phantom_antimalware_add_exclusion(phantom_antimalware_t *scanner,
                                       const char *path);

/* Remove path from exclusion list */
int phantom_antimalware_remove_exclusion(phantom_antimalware_t *scanner,
                                          const char *path);

/* Check if path is excluded */
int phantom_antimalware_is_excluded(phantom_antimalware_t *scanner,
                                     const char *filepath);

/* Clear all exclusions */
void phantom_antimalware_clear_exclusions(phantom_antimalware_t *scanner);

/* ─────────────────────────────────────────────────────────────────────────────
 * Statistics and Utility Functions
 * ───────────────────────────────────────────────────────────────────────────── */

/* Get scanner statistics */
void phantom_antimalware_get_stats(phantom_antimalware_t *scanner,
                                    uint64_t *total_scans,
                                    uint64_t *files_scanned,
                                    uint64_t *threats_found,
                                    uint64_t *files_quarantined);

/* Reset statistics */
void phantom_antimalware_reset_stats(phantom_antimalware_t *scanner);

/* Get threat level as string */
const char *phantom_antimalware_threat_str(antimalware_threat_t level);

/* Get threat level icon */
const char *phantom_antimalware_threat_icon(antimalware_threat_t level);

/* Get file type as string */
const char *phantom_antimalware_filetype_str(antimalware_filetype_t type);

/* Format heuristic flags as string */
void phantom_antimalware_format_heuristics(uint32_t flags, char *buf, size_t size);

/* ─────────────────────────────────────────────────────────────────────────────
 * Hash Utility Functions
 * ───────────────────────────────────────────────────────────────────────────── */

/* Calculate MD5 hash of file */
int phantom_antimalware_hash_file_md5(const char *filepath, char *hash_out);

/* Calculate SHA256 hash of file */
int phantom_antimalware_hash_file_sha256(const char *filepath, char *hash_out);

/* Calculate MD5 hash of data */
void phantom_antimalware_hash_data_md5(const uint8_t *data, size_t size,
                                        char *hash_out);

/* Calculate SHA256 hash of data */
void phantom_antimalware_hash_data_sha256(const uint8_t *data, size_t size,
                                           char *hash_out);

#endif /* PHANTOM_ANTIMALWARE_H */
