/*
 * ==============================================================================
 *                    PHANTOM ANTI-MALWARE SCANNER GUI
 *                      "To Create, Not To Destroy"
 * ==============================================================================
 *
 * GTK-based GUI for the PhantomOS Anti-Malware Scanner.
 */

#include "phantom_antimalware.h"
#include <gtk/gtk.h>
#include <pthread.h>
#include <time.h>

/* ─────────────────────────────────────────────────────────────────────────────
 * GUI State
 * ───────────────────────────────────────────────────────────────────────────── */

typedef struct {
    /* Scanner instance */
    phantom_antimalware_t scanner;

    /* Main window */
    GtkWidget *window;
    GtkWidget *main_stack;

    /* Header bar */
    GtkWidget *header_bar;
    GtkWidget *scan_menu_button;

    /* Dashboard widgets */
    GtkWidget *status_icon;
    GtkWidget *status_label;
    GtkWidget *last_scan_label;
    GtkWidget *threats_found_label;
    GtkWidget *files_scanned_label;
    GtkWidget *realtime_switch;
    GtkWidget *quick_scan_btn;
    GtkWidget *full_scan_btn;
    GtkWidget *custom_scan_btn;

    /* Scan progress widgets */
    GtkWidget *scan_progress_box;
    GtkWidget *scan_progress_bar;
    GtkWidget *scan_status_label;
    GtkWidget *scan_file_label;
    GtkWidget *scan_cancel_btn;

    /* Results widgets */
    GtkWidget *results_box;
    GtkWidget *results_tree;
    GtkListStore *results_store;
    GtkWidget *quarantine_btn;
    GtkWidget *ignore_btn;

    /* Quarantine widgets */
    GtkWidget *quarantine_box;
    GtkWidget *quarantine_tree;
    GtkListStore *quarantine_store;
    GtkWidget *restore_btn;
    GtkWidget *delete_btn;
    GtkWidget *empty_btn;

    /* Settings widgets */
    GtkWidget *settings_box;
    GtkWidget *heuristics_switch;
    GtkWidget *archives_switch;
    GtkWidget *hidden_switch;

    /* Scan state */
    pthread_t scan_thread;
    volatile int scan_running;
    char current_scan_file[ANTIMALWARE_MAX_PATH];
    int scan_type;  /* 0 = quick, 1 = full, 2 = custom */
    char custom_scan_path[ANTIMALWARE_MAX_PATH];

    /* Update timer */
    guint update_timer;
} antimalware_gui_t;

static antimalware_gui_t *gui = NULL;

/* ─────────────────────────────────────────────────────────────────────────────
 * CSS Styling
 * ───────────────────────────────────────────────────────────────────────────── */

static const char *antimalware_css =
    "window {"
    "  background-color: #1a1a2e;"
    "}"
    ".dashboard-card {"
    "  background-color: #16213e;"
    "  border-radius: 12px;"
    "  padding: 20px;"
    "  margin: 10px;"
    "}"
    ".status-safe {"
    "  color: #00d26a;"
    "  font-size: 48px;"
    "  font-weight: bold;"
    "}"
    ".status-warning {"
    "  color: #ffb347;"
    "  font-size: 48px;"
    "  font-weight: bold;"
    "}"
    ".status-danger {"
    "  color: #ff6b6b;"
    "  font-size: 48px;"
    "  font-weight: bold;"
    "}"
    ".stat-value {"
    "  color: #e94560;"
    "  font-size: 24px;"
    "  font-weight: bold;"
    "}"
    ".stat-label {"
    "  color: #a0a0a0;"
    "  font-size: 12px;"
    "}"
    ".scan-button {"
    "  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
    "  border-radius: 8px;"
    "  padding: 15px 30px;"
    "  color: white;"
    "  font-weight: bold;"
    "  border: none;"
    "  min-width: 150px;"
    "}"
    ".scan-button:hover {"
    "  background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);"
    "}"
    ".danger-button {"
    "  background-color: #e94560;"
    "  color: white;"
    "  border-radius: 6px;"
    "}"
    ".danger-button:hover {"
    "  background-color: #ff6b6b;"
    "}"
    ".section-title {"
    "  color: #ffffff;"
    "  font-size: 18px;"
    "  font-weight: bold;"
    "  margin-bottom: 10px;"
    "}"
    "treeview {"
    "  background-color: #16213e;"
    "  color: #ffffff;"
    "}"
    "treeview:selected {"
    "  background-color: #667eea;"
    "}"
    "switch {"
    "  background-color: #2a2a4a;"
    "}"
    "switch:checked {"
    "  background-color: #667eea;"
    "}"
    "progressbar {"
    "  min-height: 8px;"
    "}"
    "progressbar trough {"
    "  background-color: #2a2a4a;"
    "  border-radius: 4px;"
    "}"
    "progressbar progress {"
    "  background: linear-gradient(90deg, #667eea, #764ba2);"
    "  border-radius: 4px;"
    "}";

/* ─────────────────────────────────────────────────────────────────────────────
 * Forward Declarations
 * ───────────────────────────────────────────────────────────────────────────── */

static void update_dashboard(antimalware_gui_t *gui);
static void update_quarantine_list(antimalware_gui_t *gui);
static void show_scan_progress(antimalware_gui_t *gui);
static void hide_scan_progress(antimalware_gui_t *gui);

/* ─────────────────────────────────────────────────────────────────────────────
 * Scan Callbacks
 * ───────────────────────────────────────────────────────────────────────────── */

static void scan_progress_callback(const char *filepath, int percent, void *userdata) {
    antimalware_gui_t *g = (antimalware_gui_t *)userdata;
    if (filepath) {
        strncpy(g->current_scan_file, filepath, sizeof(g->current_scan_file) - 1);
    }
}

static void scan_threat_callback(const antimalware_scan_result_t *result, void *userdata) {
    antimalware_gui_t *g = (antimalware_gui_t *)userdata;

    /* Add to results store (must be done on main thread) */
    GtkTreeIter iter;
    gtk_list_store_append(g->results_store, &iter);
    gtk_list_store_set(g->results_store, &iter,
                       0, result->filepath,
                       1, phantom_antimalware_threat_str(result->threat_level),
                       2, result->threat_name[0] ? result->threat_name : "Heuristic Detection",
                       3, result->hash_sha256,
                       4, (guint64)result->file_size,
                       -1);
}

/* ─────────────────────────────────────────────────────────────────────────────
 * Scan Thread
 * ───────────────────────────────────────────────────────────────────────────── */

static void *scan_thread_func(void *arg) {
    antimalware_gui_t *g = (antimalware_gui_t *)arg;

    antimalware_scan_options_t opts = g->scanner.default_options;
    opts.progress_callback = scan_progress_callback;
    opts.threat_callback = scan_threat_callback;
    opts.callback_userdata = g;

    switch (g->scan_type) {
        case 0:  /* Quick scan */
            phantom_antimalware_quick_scan(&g->scanner, &opts);
            break;
        case 1:  /* Full scan */
            phantom_antimalware_full_scan(&g->scanner, &opts);
            break;
        case 2:  /* Custom scan */
            phantom_antimalware_scan_directory(&g->scanner, g->custom_scan_path, &opts);
            break;
    }

    g->scan_running = 0;
    return NULL;
}

/* ─────────────────────────────────────────────────────────────────────────────
 * Timer Update Function
 * ───────────────────────────────────────────────────────────────────────────── */

static gboolean update_timer_func(gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;

    if (g->scan_running) {
        /* Update progress */
        char status[256];
        snprintf(status, sizeof(status), "Scanning: %lu files, %lu threats found",
                 (unsigned long)g->scanner.current_scan_files,
                 (unsigned long)g->scanner.current_scan_threats);
        gtk_label_set_text(GTK_LABEL(g->scan_status_label), status);

        /* Pulse progress bar (indeterminate) */
        gtk_progress_bar_pulse(GTK_PROGRESS_BAR(g->scan_progress_bar));

        /* Update current file */
        if (g->current_scan_file[0]) {
            const char *filename = strrchr(g->current_scan_file, '/');
            filename = filename ? filename + 1 : g->current_scan_file;
            gtk_label_set_text(GTK_LABEL(g->scan_file_label), filename);
        }
    } else {
        /* Scan finished - hide progress, show results */
        hide_scan_progress(g);
        update_dashboard(g);
    }

    return G_SOURCE_CONTINUE;
}

/* ─────────────────────────────────────────────────────────────────────────────
 * Button Handlers
 * ───────────────────────────────────────────────────────────────────────────── */

static void on_quick_scan_clicked(GtkButton *button, gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;
    if (g->scan_running) return;

    /* Clear results */
    gtk_list_store_clear(g->results_store);

    g->scan_type = 0;
    g->scan_running = 1;
    show_scan_progress(g);

    pthread_create(&g->scan_thread, NULL, scan_thread_func, g);
}

static void on_full_scan_clicked(GtkButton *button, gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;
    if (g->scan_running) return;

    /* Clear results */
    gtk_list_store_clear(g->results_store);

    g->scan_type = 1;
    g->scan_running = 1;
    show_scan_progress(g);

    pthread_create(&g->scan_thread, NULL, scan_thread_func, g);
}

static void on_custom_scan_clicked(GtkButton *button, gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;
    if (g->scan_running) return;

    /* Show folder chooser */
    GtkWidget *dialog = gtk_file_chooser_dialog_new(
        "Select Folder to Scan",
        GTK_WINDOW(g->window),
        GTK_FILE_CHOOSER_ACTION_SELECT_FOLDER,
        "_Cancel", GTK_RESPONSE_CANCEL,
        "_Scan", GTK_RESPONSE_ACCEPT,
        NULL);

    if (gtk_dialog_run(GTK_DIALOG(dialog)) == GTK_RESPONSE_ACCEPT) {
        char *folder = gtk_file_chooser_get_filename(GTK_FILE_CHOOSER(dialog));
        strncpy(g->custom_scan_path, folder, sizeof(g->custom_scan_path) - 1);
        g_free(folder);

        /* Clear results */
        gtk_list_store_clear(g->results_store);

        g->scan_type = 2;
        g->scan_running = 1;
        show_scan_progress(g);

        pthread_create(&g->scan_thread, NULL, scan_thread_func, g);
    }

    gtk_widget_destroy(dialog);
}

static void on_cancel_scan_clicked(GtkButton *button, gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;
    phantom_antimalware_cancel_scan(&g->scanner);
}

static void on_realtime_toggled(GtkSwitch *sw, gboolean state, gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;

    if (state) {
        if (phantom_antimalware_start_realtime(&g->scanner) == 0) {
            /* Watch common directories */
            phantom_antimalware_watch_directory(&g->scanner, "/home", 1);
            phantom_antimalware_watch_directory(&g->scanner, "/tmp", 1);
        }
    } else {
        phantom_antimalware_stop_realtime(&g->scanner);
    }

    update_dashboard(g);
}

static void on_quarantine_selected(GtkButton *button, gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;

    GtkTreeSelection *sel = gtk_tree_view_get_selection(GTK_TREE_VIEW(g->results_tree));
    GtkTreeModel *model;
    GtkTreeIter iter;

    if (gtk_tree_selection_get_selected(sel, &model, &iter)) {
        gchar *filepath;
        gtk_tree_model_get(model, &iter, 0, &filepath, -1);

        /* Create a dummy result for quarantine */
        antimalware_scan_result_t result = {0};
        strncpy(result.filepath, filepath, sizeof(result.filepath) - 1);
        phantom_antimalware_hash_file_sha256(filepath, result.hash_sha256);

        if (phantom_antimalware_quarantine_file(&g->scanner, filepath, &result) == 0) {
            gtk_list_store_remove(g->results_store, &iter);
            update_quarantine_list(g);
        }

        g_free(filepath);
    }
}

static void on_restore_clicked(GtkButton *button, gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;

    GtkTreeSelection *sel = gtk_tree_view_get_selection(GTK_TREE_VIEW(g->quarantine_tree));
    GtkTreeModel *model;
    GtkTreeIter iter;

    if (gtk_tree_selection_get_selected(sel, &model, &iter)) {
        gchar *qpath;
        gtk_tree_model_get(model, &iter, 1, &qpath, -1);

        phantom_antimalware_restore_file(&g->scanner, qpath);
        update_quarantine_list(g);

        g_free(qpath);
    }
}

static void on_delete_clicked(GtkButton *button, gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;

    GtkTreeSelection *sel = gtk_tree_view_get_selection(GTK_TREE_VIEW(g->quarantine_tree));
    GtkTreeModel *model;
    GtkTreeIter iter;

    if (gtk_tree_selection_get_selected(sel, &model, &iter)) {
        gchar *qpath;
        gtk_tree_model_get(model, &iter, 1, &qpath, -1);

        phantom_antimalware_delete_quarantined(&g->scanner, qpath);
        update_quarantine_list(g);

        g_free(qpath);
    }
}

static void on_empty_quarantine_clicked(GtkButton *button, gpointer data) {
    antimalware_gui_t *g = (antimalware_gui_t *)data;

    GtkWidget *dialog = gtk_message_dialog_new(
        GTK_WINDOW(g->window),
        GTK_DIALOG_MODAL,
        GTK_MESSAGE_WARNING,
        GTK_BUTTONS_YES_NO,
        "Are you sure you want to permanently delete all quarantined files?");

    if (gtk_dialog_run(GTK_DIALOG(dialog)) == GTK_RESPONSE_YES) {
        phantom_antimalware_empty_quarantine(&g->scanner);
        update_quarantine_list(g);
    }

    gtk_widget_destroy(dialog);
}

static void on_nav_clicked(GtkButton *button, gpointer data) {
    const char *page = (const char *)data;
    gtk_stack_set_visible_child_name(GTK_STACK(gui->main_stack), page);
}

/* ─────────────────────────────────────────────────────────────────────────────
 * UI Update Functions
 * ───────────────────────────────────────────────────────────────────────────── */

static void update_dashboard(antimalware_gui_t *g) {
    uint64_t total, files, threats, quarantined;
    phantom_antimalware_get_stats(&g->scanner, &total, &files, &threats, &quarantined);

    /* Update status */
    if (g->scanner.realtime_enabled) {
        gtk_label_set_text(GTK_LABEL(g->status_label), "Protected");
        gtk_style_context_remove_class(
            gtk_widget_get_style_context(g->status_label), "status-warning");
        gtk_style_context_remove_class(
            gtk_widget_get_style_context(g->status_label), "status-danger");
        gtk_style_context_add_class(
            gtk_widget_get_style_context(g->status_label), "status-safe");
    } else {
        gtk_label_set_text(GTK_LABEL(g->status_label), "Unprotected");
        gtk_style_context_remove_class(
            gtk_widget_get_style_context(g->status_label), "status-safe");
        gtk_style_context_remove_class(
            gtk_widget_get_style_context(g->status_label), "status-danger");
        gtk_style_context_add_class(
            gtk_widget_get_style_context(g->status_label), "status-warning");
    }

    /* Update stats */
    char buf[64];

    snprintf(buf, sizeof(buf), "%lu", (unsigned long)files);
    gtk_label_set_text(GTK_LABEL(g->files_scanned_label), buf);

    snprintf(buf, sizeof(buf), "%lu", (unsigned long)threats);
    gtk_label_set_text(GTK_LABEL(g->threats_found_label), buf);

    /* Update last scan time */
    if (total > 0) {
        time_t now = time(NULL);
        gtk_label_set_text(GTK_LABEL(g->last_scan_label), "Just now");
    } else {
        gtk_label_set_text(GTK_LABEL(g->last_scan_label), "Never");
    }

    /* Update realtime switch */
    gtk_switch_set_active(GTK_SWITCH(g->realtime_switch), g->scanner.realtime_enabled);
}

static void update_quarantine_list(antimalware_gui_t *g) {
    gtk_list_store_clear(g->quarantine_store);

    antimalware_quarantine_entry_t *entry = phantom_antimalware_list_quarantine(&g->scanner);
    while (entry) {
        GtkTreeIter iter;
        gtk_list_store_append(g->quarantine_store, &iter);

        char time_str[64];
        struct tm *tm = localtime(&entry->quarantine_time);
        strftime(time_str, sizeof(time_str), "%Y-%m-%d %H:%M", tm);

        gtk_list_store_set(g->quarantine_store, &iter,
                           0, entry->original_path,
                           1, entry->quarantine_path,
                           2, entry->threat_name,
                           3, time_str,
                           4, (guint64)entry->file_size,
                           -1);

        entry = entry->next;
    }
}

static void show_scan_progress(antimalware_gui_t *g) {
    gtk_widget_show(g->scan_progress_box);
    gtk_widget_set_sensitive(g->quick_scan_btn, FALSE);
    gtk_widget_set_sensitive(g->full_scan_btn, FALSE);
    gtk_widget_set_sensitive(g->custom_scan_btn, FALSE);
}

static void hide_scan_progress(antimalware_gui_t *g) {
    gtk_widget_hide(g->scan_progress_box);
    gtk_widget_set_sensitive(g->quick_scan_btn, TRUE);
    gtk_widget_set_sensitive(g->full_scan_btn, TRUE);
    gtk_widget_set_sensitive(g->custom_scan_btn, TRUE);
}

/* ─────────────────────────────────────────────────────────────────────────────
 * Widget Creation
 * ───────────────────────────────────────────────────────────────────────────── */

static GtkWidget *create_stat_card(const char *label, GtkWidget **value_label) {
    GtkWidget *card = gtk_box_new(GTK_ORIENTATION_VERTICAL, 5);
    gtk_style_context_add_class(gtk_widget_get_style_context(card), "dashboard-card");

    *value_label = gtk_label_new("0");
    gtk_style_context_add_class(gtk_widget_get_style_context(*value_label), "stat-value");
    gtk_box_pack_start(GTK_BOX(card), *value_label, FALSE, FALSE, 0);

    GtkWidget *name = gtk_label_new(label);
    gtk_style_context_add_class(gtk_widget_get_style_context(name), "stat-label");
    gtk_box_pack_start(GTK_BOX(card), name, FALSE, FALSE, 0);

    return card;
}

static GtkWidget *create_dashboard_page(antimalware_gui_t *g) {
    GtkWidget *page = gtk_box_new(GTK_ORIENTATION_VERTICAL, 20);
    gtk_widget_set_margin_start(page, 30);
    gtk_widget_set_margin_end(page, 30);
    gtk_widget_set_margin_top(page, 20);
    gtk_widget_set_margin_bottom(page, 20);

    /* Status section */
    GtkWidget *status_box = gtk_box_new(GTK_ORIENTATION_VERTICAL, 10);
    gtk_style_context_add_class(gtk_widget_get_style_context(status_box), "dashboard-card");
    gtk_widget_set_halign(status_box, GTK_ALIGN_CENTER);

    g->status_label = gtk_label_new("Unprotected");
    gtk_style_context_add_class(gtk_widget_get_style_context(g->status_label), "status-warning");
    gtk_box_pack_start(GTK_BOX(status_box), g->status_label, FALSE, FALSE, 0);

    GtkWidget *realtime_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 10);
    gtk_widget_set_halign(realtime_box, GTK_ALIGN_CENTER);
    GtkWidget *realtime_label = gtk_label_new("Real-time Protection");
    g->realtime_switch = gtk_switch_new();
    g_signal_connect(g->realtime_switch, "state-set", G_CALLBACK(on_realtime_toggled), g);
    gtk_box_pack_start(GTK_BOX(realtime_box), realtime_label, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(realtime_box), g->realtime_switch, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(status_box), realtime_box, FALSE, FALSE, 10);

    gtk_box_pack_start(GTK_BOX(page), status_box, FALSE, FALSE, 0);

    /* Stats section */
    GtkWidget *stats_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 20);
    gtk_widget_set_halign(stats_box, GTK_ALIGN_CENTER);

    GtkWidget *card1 = create_stat_card("Files Scanned", &g->files_scanned_label);
    GtkWidget *card2 = create_stat_card("Threats Found", &g->threats_found_label);
    GtkWidget *card3 = create_stat_card("Last Scan", &g->last_scan_label);
    gtk_label_set_text(GTK_LABEL(g->last_scan_label), "Never");

    gtk_box_pack_start(GTK_BOX(stats_box), card1, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(stats_box), card2, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(stats_box), card3, FALSE, FALSE, 0);

    gtk_box_pack_start(GTK_BOX(page), stats_box, FALSE, FALSE, 0);

    /* Scan buttons */
    GtkWidget *btn_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 15);
    gtk_widget_set_halign(btn_box, GTK_ALIGN_CENTER);

    g->quick_scan_btn = gtk_button_new_with_label("Quick Scan");
    gtk_style_context_add_class(gtk_widget_get_style_context(g->quick_scan_btn), "scan-button");
    g_signal_connect(g->quick_scan_btn, "clicked", G_CALLBACK(on_quick_scan_clicked), g);

    g->full_scan_btn = gtk_button_new_with_label("Full Scan");
    gtk_style_context_add_class(gtk_widget_get_style_context(g->full_scan_btn), "scan-button");
    g_signal_connect(g->full_scan_btn, "clicked", G_CALLBACK(on_full_scan_clicked), g);

    g->custom_scan_btn = gtk_button_new_with_label("Custom Scan");
    gtk_style_context_add_class(gtk_widget_get_style_context(g->custom_scan_btn), "scan-button");
    g_signal_connect(g->custom_scan_btn, "clicked", G_CALLBACK(on_custom_scan_clicked), g);

    gtk_box_pack_start(GTK_BOX(btn_box), g->quick_scan_btn, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(btn_box), g->full_scan_btn, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(btn_box), g->custom_scan_btn, FALSE, FALSE, 0);

    gtk_box_pack_start(GTK_BOX(page), btn_box, FALSE, FALSE, 0);

    /* Scan progress (hidden by default) */
    g->scan_progress_box = gtk_box_new(GTK_ORIENTATION_VERTICAL, 10);
    gtk_style_context_add_class(gtk_widget_get_style_context(g->scan_progress_box), "dashboard-card");

    g->scan_status_label = gtk_label_new("Scanning...");
    gtk_box_pack_start(GTK_BOX(g->scan_progress_box), g->scan_status_label, FALSE, FALSE, 0);

    g->scan_progress_bar = gtk_progress_bar_new();
    gtk_box_pack_start(GTK_BOX(g->scan_progress_box), g->scan_progress_bar, FALSE, FALSE, 0);

    g->scan_file_label = gtk_label_new("");
    gtk_label_set_ellipsize(GTK_LABEL(g->scan_file_label), PANGO_ELLIPSIZE_MIDDLE);
    gtk_box_pack_start(GTK_BOX(g->scan_progress_box), g->scan_file_label, FALSE, FALSE, 0);

    g->scan_cancel_btn = gtk_button_new_with_label("Cancel");
    gtk_style_context_add_class(gtk_widget_get_style_context(g->scan_cancel_btn), "danger-button");
    g_signal_connect(g->scan_cancel_btn, "clicked", G_CALLBACK(on_cancel_scan_clicked), g);
    gtk_widget_set_halign(g->scan_cancel_btn, GTK_ALIGN_CENTER);
    gtk_box_pack_start(GTK_BOX(g->scan_progress_box), g->scan_cancel_btn, FALSE, FALSE, 0);

    gtk_box_pack_start(GTK_BOX(page), g->scan_progress_box, FALSE, FALSE, 0);
    gtk_widget_hide(g->scan_progress_box);

    return page;
}

static GtkWidget *create_results_page(antimalware_gui_t *g) {
    GtkWidget *page = gtk_box_new(GTK_ORIENTATION_VERTICAL, 10);
    gtk_widget_set_margin_start(page, 20);
    gtk_widget_set_margin_end(page, 20);
    gtk_widget_set_margin_top(page, 20);

    GtkWidget *title = gtk_label_new("Scan Results");
    gtk_style_context_add_class(gtk_widget_get_style_context(title), "section-title");
    gtk_widget_set_halign(title, GTK_ALIGN_START);
    gtk_box_pack_start(GTK_BOX(page), title, FALSE, FALSE, 0);

    /* Results list */
    g->results_store = gtk_list_store_new(5,
        G_TYPE_STRING,   /* File path */
        G_TYPE_STRING,   /* Threat type */
        G_TYPE_STRING,   /* Threat name */
        G_TYPE_STRING,   /* Hash */
        G_TYPE_UINT64);  /* Size */

    g->results_tree = gtk_tree_view_new_with_model(GTK_TREE_MODEL(g->results_store));

    GtkCellRenderer *renderer = gtk_cell_renderer_text_new();

    GtkTreeViewColumn *col1 = gtk_tree_view_column_new_with_attributes(
        "File", renderer, "text", 0, NULL);
    gtk_tree_view_column_set_expand(col1, TRUE);
    gtk_tree_view_append_column(GTK_TREE_VIEW(g->results_tree), col1);

    GtkTreeViewColumn *col2 = gtk_tree_view_column_new_with_attributes(
        "Threat Type", renderer, "text", 1, NULL);
    gtk_tree_view_append_column(GTK_TREE_VIEW(g->results_tree), col2);

    GtkTreeViewColumn *col3 = gtk_tree_view_column_new_with_attributes(
        "Detection", renderer, "text", 2, NULL);
    gtk_tree_view_append_column(GTK_TREE_VIEW(g->results_tree), col3);

    GtkWidget *scroll = gtk_scrolled_window_new(NULL, NULL);
    gtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(scroll),
                                   GTK_POLICY_AUTOMATIC, GTK_POLICY_AUTOMATIC);
    gtk_container_add(GTK_CONTAINER(scroll), g->results_tree);
    gtk_box_pack_start(GTK_BOX(page), scroll, TRUE, TRUE, 0);

    /* Action buttons */
    GtkWidget *btn_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 10);
    gtk_widget_set_halign(btn_box, GTK_ALIGN_END);

    g->quarantine_btn = gtk_button_new_with_label("Quarantine Selected");
    gtk_style_context_add_class(gtk_widget_get_style_context(g->quarantine_btn), "danger-button");
    g_signal_connect(g->quarantine_btn, "clicked", G_CALLBACK(on_quarantine_selected), g);

    g->ignore_btn = gtk_button_new_with_label("Ignore");

    gtk_box_pack_start(GTK_BOX(btn_box), g->ignore_btn, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(btn_box), g->quarantine_btn, FALSE, FALSE, 0);

    gtk_box_pack_start(GTK_BOX(page), btn_box, FALSE, FALSE, 10);

    return page;
}

static GtkWidget *create_quarantine_page(antimalware_gui_t *g) {
    GtkWidget *page = gtk_box_new(GTK_ORIENTATION_VERTICAL, 10);
    gtk_widget_set_margin_start(page, 20);
    gtk_widget_set_margin_end(page, 20);
    gtk_widget_set_margin_top(page, 20);

    GtkWidget *title = gtk_label_new("Quarantine");
    gtk_style_context_add_class(gtk_widget_get_style_context(title), "section-title");
    gtk_widget_set_halign(title, GTK_ALIGN_START);
    gtk_box_pack_start(GTK_BOX(page), title, FALSE, FALSE, 0);

    /* Quarantine list */
    g->quarantine_store = gtk_list_store_new(5,
        G_TYPE_STRING,   /* Original path */
        G_TYPE_STRING,   /* Quarantine path */
        G_TYPE_STRING,   /* Threat name */
        G_TYPE_STRING,   /* Date */
        G_TYPE_UINT64);  /* Size */

    g->quarantine_tree = gtk_tree_view_new_with_model(GTK_TREE_MODEL(g->quarantine_store));

    GtkCellRenderer *renderer = gtk_cell_renderer_text_new();

    GtkTreeViewColumn *col1 = gtk_tree_view_column_new_with_attributes(
        "Original Location", renderer, "text", 0, NULL);
    gtk_tree_view_column_set_expand(col1, TRUE);
    gtk_tree_view_append_column(GTK_TREE_VIEW(g->quarantine_tree), col1);

    GtkTreeViewColumn *col2 = gtk_tree_view_column_new_with_attributes(
        "Threat", renderer, "text", 2, NULL);
    gtk_tree_view_append_column(GTK_TREE_VIEW(g->quarantine_tree), col2);

    GtkTreeViewColumn *col3 = gtk_tree_view_column_new_with_attributes(
        "Quarantined", renderer, "text", 3, NULL);
    gtk_tree_view_append_column(GTK_TREE_VIEW(g->quarantine_tree), col3);

    GtkWidget *scroll = gtk_scrolled_window_new(NULL, NULL);
    gtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(scroll),
                                   GTK_POLICY_AUTOMATIC, GTK_POLICY_AUTOMATIC);
    gtk_container_add(GTK_CONTAINER(scroll), g->quarantine_tree);
    gtk_box_pack_start(GTK_BOX(page), scroll, TRUE, TRUE, 0);

    /* Action buttons */
    GtkWidget *btn_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 10);
    gtk_widget_set_halign(btn_box, GTK_ALIGN_END);

    g->restore_btn = gtk_button_new_with_label("Restore");
    g_signal_connect(g->restore_btn, "clicked", G_CALLBACK(on_restore_clicked), g);

    g->delete_btn = gtk_button_new_with_label("Delete");
    gtk_style_context_add_class(gtk_widget_get_style_context(g->delete_btn), "danger-button");
    g_signal_connect(g->delete_btn, "clicked", G_CALLBACK(on_delete_clicked), g);

    g->empty_btn = gtk_button_new_with_label("Empty Quarantine");
    gtk_style_context_add_class(gtk_widget_get_style_context(g->empty_btn), "danger-button");
    g_signal_connect(g->empty_btn, "clicked", G_CALLBACK(on_empty_quarantine_clicked), g);

    gtk_box_pack_start(GTK_BOX(btn_box), g->restore_btn, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(btn_box), g->delete_btn, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(btn_box), g->empty_btn, FALSE, FALSE, 0);

    gtk_box_pack_start(GTK_BOX(page), btn_box, FALSE, FALSE, 10);

    return page;
}

static GtkWidget *create_settings_page(antimalware_gui_t *g) {
    GtkWidget *page = gtk_box_new(GTK_ORIENTATION_VERTICAL, 15);
    gtk_widget_set_margin_start(page, 20);
    gtk_widget_set_margin_end(page, 20);
    gtk_widget_set_margin_top(page, 20);

    GtkWidget *title = gtk_label_new("Settings");
    gtk_style_context_add_class(gtk_widget_get_style_context(title), "section-title");
    gtk_widget_set_halign(title, GTK_ALIGN_START);
    gtk_box_pack_start(GTK_BOX(page), title, FALSE, FALSE, 0);

    /* Settings card */
    GtkWidget *card = gtk_box_new(GTK_ORIENTATION_VERTICAL, 15);
    gtk_style_context_add_class(gtk_widget_get_style_context(card), "dashboard-card");

    /* Heuristics */
    GtkWidget *row1 = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 10);
    GtkWidget *label1 = gtk_label_new("Enable Heuristic Analysis");
    gtk_widget_set_hexpand(label1, TRUE);
    gtk_widget_set_halign(label1, GTK_ALIGN_START);
    g->heuristics_switch = gtk_switch_new();
    gtk_switch_set_active(GTK_SWITCH(g->heuristics_switch), TRUE);
    gtk_box_pack_start(GTK_BOX(row1), label1, TRUE, TRUE, 0);
    gtk_box_pack_start(GTK_BOX(row1), g->heuristics_switch, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(card), row1, FALSE, FALSE, 0);

    /* Scan archives */
    GtkWidget *row2 = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 10);
    GtkWidget *label2 = gtk_label_new("Scan Inside Archives");
    gtk_widget_set_hexpand(label2, TRUE);
    gtk_widget_set_halign(label2, GTK_ALIGN_START);
    g->archives_switch = gtk_switch_new();
    gtk_box_pack_start(GTK_BOX(row2), label2, TRUE, TRUE, 0);
    gtk_box_pack_start(GTK_BOX(row2), g->archives_switch, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(card), row2, FALSE, FALSE, 0);

    /* Scan hidden */
    GtkWidget *row3 = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 10);
    GtkWidget *label3 = gtk_label_new("Scan Hidden Files");
    gtk_widget_set_hexpand(label3, TRUE);
    gtk_widget_set_halign(label3, GTK_ALIGN_START);
    g->hidden_switch = gtk_switch_new();
    gtk_switch_set_active(GTK_SWITCH(g->hidden_switch), TRUE);
    gtk_box_pack_start(GTK_BOX(row3), label3, TRUE, TRUE, 0);
    gtk_box_pack_start(GTK_BOX(row3), g->hidden_switch, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(card), row3, FALSE, FALSE, 0);

    gtk_box_pack_start(GTK_BOX(page), card, FALSE, FALSE, 0);

    /* Signature info */
    GtkWidget *sig_card = gtk_box_new(GTK_ORIENTATION_VERTICAL, 10);
    gtk_style_context_add_class(gtk_widget_get_style_context(sig_card), "dashboard-card");

    GtkWidget *sig_title = gtk_label_new("Signature Database");
    gtk_style_context_add_class(gtk_widget_get_style_context(sig_title), "section-title");
    gtk_widget_set_halign(sig_title, GTK_ALIGN_START);
    gtk_box_pack_start(GTK_BOX(sig_card), sig_title, FALSE, FALSE, 0);

    char sig_info[128];
    snprintf(sig_info, sizeof(sig_info), "Loaded signatures: %u",
             phantom_antimalware_get_signature_count(&g->scanner));
    GtkWidget *sig_label = gtk_label_new(sig_info);
    gtk_widget_set_halign(sig_label, GTK_ALIGN_START);
    gtk_box_pack_start(GTK_BOX(sig_card), sig_label, FALSE, FALSE, 0);

    GtkWidget *update_btn = gtk_button_new_with_label("Update Signatures");
    gtk_widget_set_halign(update_btn, GTK_ALIGN_START);
    gtk_box_pack_start(GTK_BOX(sig_card), update_btn, FALSE, FALSE, 0);

    gtk_box_pack_start(GTK_BOX(page), sig_card, FALSE, FALSE, 0);

    return page;
}

/* ─────────────────────────────────────────────────────────────────────────────
 * Main Window Creation
 * ───────────────────────────────────────────────────────────────────────────── */

static void create_main_window(antimalware_gui_t *g) {
    /* Apply CSS */
    GtkCssProvider *css = gtk_css_provider_new();
    gtk_css_provider_load_from_data(css, antimalware_css, -1, NULL);
    gtk_style_context_add_provider_for_screen(
        gdk_screen_get_default(),
        GTK_STYLE_PROVIDER(css),
        GTK_STYLE_PROVIDER_PRIORITY_APPLICATION);

    /* Main window */
    g->window = gtk_window_new(GTK_WINDOW_TOPLEVEL);
    gtk_window_set_title(GTK_WINDOW(g->window), "Phantom Anti-Malware");
    gtk_window_set_default_size(GTK_WINDOW(g->window), 900, 650);
    g_signal_connect(g->window, "destroy", G_CALLBACK(gtk_main_quit), NULL);

    /* Main layout */
    GtkWidget *main_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);
    gtk_container_add(GTK_CONTAINER(g->window), main_box);

    /* Sidebar */
    GtkWidget *sidebar = gtk_box_new(GTK_ORIENTATION_VERTICAL, 5);
    gtk_widget_set_size_request(sidebar, 200, -1);
    gtk_style_context_add_class(gtk_widget_get_style_context(sidebar), "dashboard-card");

    GtkWidget *logo_label = gtk_label_new("Phantom AV");
    gtk_style_context_add_class(gtk_widget_get_style_context(logo_label), "section-title");
    gtk_box_pack_start(GTK_BOX(sidebar), logo_label, FALSE, FALSE, 20);

    GtkWidget *nav_dashboard = gtk_button_new_with_label("Dashboard");
    g_signal_connect(nav_dashboard, "clicked", G_CALLBACK(on_nav_clicked), "dashboard");
    gtk_box_pack_start(GTK_BOX(sidebar), nav_dashboard, FALSE, FALSE, 5);

    GtkWidget *nav_results = gtk_button_new_with_label("Scan Results");
    g_signal_connect(nav_results, "clicked", G_CALLBACK(on_nav_clicked), "results");
    gtk_box_pack_start(GTK_BOX(sidebar), nav_results, FALSE, FALSE, 5);

    GtkWidget *nav_quarantine = gtk_button_new_with_label("Quarantine");
    g_signal_connect(nav_quarantine, "clicked", G_CALLBACK(on_nav_clicked), "quarantine");
    gtk_box_pack_start(GTK_BOX(sidebar), nav_quarantine, FALSE, FALSE, 5);

    GtkWidget *nav_settings = gtk_button_new_with_label("Settings");
    g_signal_connect(nav_settings, "clicked", G_CALLBACK(on_nav_clicked), "settings");
    gtk_box_pack_start(GTK_BOX(sidebar), nav_settings, FALSE, FALSE, 5);

    gtk_box_pack_start(GTK_BOX(main_box), sidebar, FALSE, FALSE, 0);

    /* Content stack */
    g->main_stack = gtk_stack_new();
    gtk_stack_set_transition_type(GTK_STACK(g->main_stack), GTK_STACK_TRANSITION_TYPE_CROSSFADE);

    gtk_stack_add_named(GTK_STACK(g->main_stack), create_dashboard_page(g), "dashboard");
    gtk_stack_add_named(GTK_STACK(g->main_stack), create_results_page(g), "results");
    gtk_stack_add_named(GTK_STACK(g->main_stack), create_quarantine_page(g), "quarantine");
    gtk_stack_add_named(GTK_STACK(g->main_stack), create_settings_page(g), "settings");

    gtk_box_pack_start(GTK_BOX(main_box), g->main_stack, TRUE, TRUE, 0);

    /* Start update timer */
    g->update_timer = g_timeout_add(100, update_timer_func, g);
}

/* ─────────────────────────────────────────────────────────────────────────────
 * Main Entry Point
 * ───────────────────────────────────────────────────────────────────────────── */

int phantom_antimalware_gui_main(int argc, char *argv[]) {
    gtk_init(&argc, &argv);

    gui = malloc(sizeof(antimalware_gui_t));
    if (!gui) return 1;

    memset(gui, 0, sizeof(antimalware_gui_t));

    /* Initialize scanner */
    if (phantom_antimalware_init(&gui->scanner) != 0) {
        free(gui);
        return 1;
    }

    /* Set quarantine path */
    char quarantine_path[256];
    snprintf(quarantine_path, sizeof(quarantine_path), "%s/.phantom/quarantine",
             getenv("HOME") ? getenv("HOME") : "/tmp");
    phantom_antimalware_set_quarantine_path(&gui->scanner, quarantine_path);

    /* Load signatures if available */
    phantom_antimalware_load_signature_dir(&gui->scanner, "/usr/share/phantom/signatures");
    phantom_antimalware_load_signature_dir(&gui->scanner, "geo/etc/signatures");

    /* Create GUI */
    create_main_window(gui);
    gtk_widget_show_all(gui->window);
    gtk_widget_hide(gui->scan_progress_box);

    /* Initial update */
    update_dashboard(gui);
    update_quarantine_list(gui);

    gtk_main();

    /* Cleanup */
    if (gui->update_timer) {
        g_source_remove(gui->update_timer);
    }
    phantom_antimalware_shutdown(&gui->scanner);
    free(gui);

    return 0;
}

/* Alternative entry for embedding in PhantomOS */
void phantom_antimalware_show_window(void) {
    if (!gui) {
        char *argv[] = {"phantom-antimalware", NULL};
        phantom_antimalware_gui_main(1, argv);
    } else {
        gtk_widget_show(gui->window);
        gtk_window_present(GTK_WINDOW(gui->window));
    }
}
