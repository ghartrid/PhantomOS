/*
 * ==============================================================================
 *                    PHANTOM ANTI-MALWARE - MAIN ENTRY POINT
 *                         "To Create, Not To Destroy"
 * ==============================================================================
 *
 * Standalone launcher for the Phantom Anti-Malware Scanner.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <getopt.h>
#include <sys/stat.h>
#include "phantom_antimalware.h"

/* External GUI function */
extern int phantom_antimalware_gui_main(int argc, char *argv[]);

/* ─────────────────────────────────────────────────────────────────────────────
 * Command Line Interface
 * ───────────────────────────────────────────────────────────────────────────── */

static void print_usage(const char *progname) {
    printf("Phantom Anti-Malware Scanner\n");
    printf("\"To Create, Not To Destroy\"\n\n");
    printf("Usage: %s [OPTIONS] [PATH...]\n\n", progname);
    printf("Options:\n");
    printf("  -g, --gui          Launch graphical interface\n");
    printf("  -s, --scan PATH    Scan file or directory\n");
    printf("  -q, --quick        Quick scan (common locations)\n");
    printf("  -f, --full         Full system scan\n");
    printf("  -r, --recursive    Scan directories recursively (default)\n");
    printf("  -n, --no-recursive Don't scan recursively\n");
    printf("  -H, --heuristics   Enable heuristic analysis (default)\n");
    printf("  -N, --no-heuristics Disable heuristic analysis\n");
    printf("  -v, --verbose      Verbose output\n");
    printf("  -h, --help         Show this help message\n");
    printf("\n");
    printf("Examples:\n");
    printf("  %s --gui                    Launch GUI\n", progname);
    printf("  %s -s /home/user/Downloads  Scan directory\n", progname);
    printf("  %s -q                       Quick scan\n", progname);
    printf("  %s -f                       Full system scan\n", progname);
    printf("\n");
}

static void cli_progress_callback(const char *filepath, int percent, void *userdata) {
    int *verbose = (int *)userdata;
    if (*verbose && filepath) {
        printf("Scanning: %s\n", filepath);
    }
}

static void cli_threat_callback(const antimalware_scan_result_t *result, void *userdata) {
    printf("\n%s THREAT DETECTED %s\n",
           "========================================",
           "========================================");
    printf("File:        %s\n", result->filepath);
    printf("Threat Type: %s\n", phantom_antimalware_threat_str(result->threat_level));
    printf("Detection:   %s\n", result->threat_name[0] ? result->threat_name : "Heuristic");
    printf("SHA256:      %s\n", result->hash_sha256);
    printf("Score:       %d/100\n", result->threat_score);

    if (result->heuristic_flags) {
        char flags_str[512];
        phantom_antimalware_format_heuristics(result->heuristic_flags, flags_str, sizeof(flags_str));
        printf("Heuristics:  %s\n", flags_str);
    }

    printf("=================================================================================\n\n");
}

int main(int argc, char *argv[]) {
    int use_gui = 0;
    int quick_scan = 0;
    int full_scan = 0;
    int recursive = 1;
    int heuristics = 1;
    int verbose = 0;
    char *scan_path = NULL;

    static struct option long_options[] = {
        {"gui",           no_argument,       0, 'g'},
        {"scan",          required_argument, 0, 's'},
        {"quick",         no_argument,       0, 'q'},
        {"full",          no_argument,       0, 'f'},
        {"recursive",     no_argument,       0, 'r'},
        {"no-recursive",  no_argument,       0, 'n'},
        {"heuristics",    no_argument,       0, 'H'},
        {"no-heuristics", no_argument,       0, 'N'},
        {"verbose",       no_argument,       0, 'v'},
        {"help",          no_argument,       0, 'h'},
        {0, 0, 0, 0}
    };

    int opt;
    while ((opt = getopt_long(argc, argv, "gs:qfrnHNvh", long_options, NULL)) != -1) {
        switch (opt) {
            case 'g':
                use_gui = 1;
                break;
            case 's':
                scan_path = optarg;
                break;
            case 'q':
                quick_scan = 1;
                break;
            case 'f':
                full_scan = 1;
                break;
            case 'r':
                recursive = 1;
                break;
            case 'n':
                recursive = 0;
                break;
            case 'H':
                heuristics = 1;
                break;
            case 'N':
                heuristics = 0;
                break;
            case 'v':
                verbose = 1;
                break;
            case 'h':
            default:
                print_usage(argv[0]);
                return opt == 'h' ? 0 : 1;
        }
    }

    /* If no options, show usage or launch GUI */
    if (argc == 1) {
        /* Default: launch GUI */
        return phantom_antimalware_gui_main(argc, argv);
    }

    /* GUI mode */
    if (use_gui) {
        return phantom_antimalware_gui_main(argc, argv);
    }

    /* CLI mode */
    printf("Phantom Anti-Malware Scanner\n");
    printf("============================\n\n");

    phantom_antimalware_t scanner;
    if (phantom_antimalware_init(&scanner) != 0) {
        fprintf(stderr, "Error: Failed to initialize scanner\n");
        return 1;
    }

    /* Load signatures */
    int loaded = phantom_antimalware_load_signature_dir(&scanner, "/usr/share/phantom/signatures");
    loaded += phantom_antimalware_load_signature_dir(&scanner, "geo/etc/signatures");
    printf("Loaded %d signatures\n\n", loaded);

    /* Set up scan options */
    antimalware_scan_options_t opts = scanner.default_options;
    opts.recursive = recursive;
    opts.heuristics_enabled = heuristics;
    opts.progress_callback = cli_progress_callback;
    opts.threat_callback = cli_threat_callback;
    opts.callback_userdata = &verbose;

    int threats = 0;

    if (quick_scan) {
        printf("Starting quick scan...\n\n");
        threats = phantom_antimalware_quick_scan(&scanner, &opts);
    } else if (full_scan) {
        printf("Starting full system scan...\n\n");
        printf("WARNING: This may take a long time!\n\n");
        threats = phantom_antimalware_full_scan(&scanner, &opts);
    } else if (scan_path) {
        printf("Scanning: %s\n\n", scan_path);
        struct stat st;
        if (stat(scan_path, &st) == 0 && S_ISREG(st.st_mode)) {
            /* Single file scan */
            antimalware_scan_result_t result;
            int t = phantom_antimalware_scan_file(&scanner, scan_path, &result, &opts);
            if (t > 0) {
                cli_threat_callback(&result, &verbose);
                threats = 1;
            }
        } else {
            threats = phantom_antimalware_scan_directory(&scanner, scan_path, &opts);
        }
    } else if (optind < argc) {
        /* Scan remaining arguments as paths */
        for (int i = optind; i < argc; i++) {
            printf("Scanning: %s\n", argv[i]);
            struct stat st;
            if (stat(argv[i], &st) == 0 && S_ISREG(st.st_mode)) {
                /* Single file scan */
                antimalware_scan_result_t result;
                int t = phantom_antimalware_scan_file(&scanner, argv[i], &result, &opts);
                if (t > 0) {
                    cli_threat_callback(&result, &verbose);
                    threats++;
                }
            } else {
                int t = phantom_antimalware_scan_directory(&scanner, argv[i], &opts);
                if (t > 0) threats += t;
            }
        }
    } else {
        fprintf(stderr, "Error: No scan target specified\n");
        print_usage(argv[0]);
        phantom_antimalware_shutdown(&scanner);
        return 1;
    }

    /* Print summary */
    printf("\n============================\n");
    printf("Scan Complete!\n");
    printf("============================\n");

    uint64_t total, files, found, quarantined;
    phantom_antimalware_get_stats(&scanner, &total, &files, &found, &quarantined);

    printf("Files scanned:    %lu\n", (unsigned long)files);
    printf("Threats found:    %lu\n", (unsigned long)found);
    printf("Files quarantined: %lu\n", (unsigned long)quarantined);

    if (found > 0) {
        printf("\nRecommendation: Run with --gui to quarantine detected threats.\n");
    } else {
        printf("\nNo threats detected. Your system appears clean.\n");
    }

    phantom_antimalware_shutdown(&scanner);
    return threats > 0 ? 1 : 0;
}
